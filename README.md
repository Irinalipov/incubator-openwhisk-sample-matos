# message-hub-kafka-ssl
This Java sample can connect to one of the Message Hub Kafka endpoints. It can be
used on multiple platforms - [IBM Bluemix](https://console.ng.bluemix.net/) or your own machine!

__Important Note__: This sample creates a topic on your behalf with one partition - this will incur a fee if the topic does not already exist on your account.

## Global Prerequisites
To build and run the sample, you must have the following installed:
* [git](https://git-scm.com/)
* [Gradle](https://gradle.org/)
* Java 7+
* [Message Hub Service Instance](https://console.ng.bluemix.net/catalog/services/message-hub/) provisioned in [IBM Bluemix](https://console.ng.bluemix.net/)

## Prerequisites (Local)
[View the video tutorial](https://www.youtube.com/watch?v=tt-bLtFzC_4) 
__Note:__ You no longer need to update the SASL configuration manually.

#### Updating the Properties Files
Firstly, you will need to update the consumer and producer properties files. These can be found
in the ```resources``` directory. The only keys you need to update in each of the consumer and
producer properties files are the following:

* ssl.truststore.location
  * Set to the location of the `cacerts` file, most commonly located in _java.home_/lib/security
* ssl.truststore.password
  * If you have not changed the password, the default is _changeit_

#### Updating SASL Configuration
You no longer need to update the SASL Configuration manually - it is generated at run-time.

## Prerequisites (Bluemix)
* [Cloud Foundry Command Line Interface](https://github.com/cloudfoundry/cli/releases) installed
* Open the `manifest.yml` file and rename the `"message-hub-service"` entry to that of your own
Message Hub Service Instance name.

## Running the Build Script
Run the following commands on your local machine, after the prerequisites for your environment have been completed:
```shell
gradle clean && gradle build
 ```

This will download the required dependencies and copy any files located in the lib-message-hub directory.
Once built, the sample can be located in the `build/libs` directory, along with the `resources` folder,
log4j configuration and any libraries required by the sample.

## Running the Sample (Local)
To run the sample, navigate to the `build/libs` directory and run the following command:
```shell
java -Djava.security.auth.login.config=resources/jaas.conf -jar <name_of_jar>.jar <kafka_endpoint> <rest_endpoint> <api_key>
```

The sample will run indefinitely until interrupted. To stop the process, use `Ctrl+C`, for example.

## Running the Sample (Bluemix)
Connect to Bluemix with the Cloud Foundry Command Line Interface, then run the following command in
the same directory as the `manifest.yml` file:
```shell
cf push
```

__Note:__ The Bluemix distribution will automatically update the required files for you at runtime,
using the `VCAP_SERVICES` information provided by Bluemix.

## Sample Output
Below is a snippet of the output generated by the sample. Note that the sample will also create
a topic for you.

```
[2015-12-11 11:12:10,086] INFO Running in local mode. (com.messagehub.samples.MessageHubJavaSample)
[2015-12-11 11:12:10,086] INFO Starting Message Hub Java Sample (com.messagehub.samples.MessageHubJavaSample)
[2015-12-11 11:12:10,086] INFO Sample will run until interrupted. (com.messagehub.samples.MessageHubJavaSample)
[2015-12-11 11:12:10,087] INFO Resource directory: <directory_name> (com.messagehub.samples.MessageHubJavaSample)
[2015-12-11 11:12:10,087] INFO Kafka Endpoint: kafka01-prod01.messagehub.services.us-south.bluemix.net:9094 (com.messagehub.samples.MessageHubJavaSample)
[2015-12-11 11:12:10,087] INFO Rest API Endpoint: https://kafka-rest-prod01.messagehub.services.us-south.bluemix.net:443 (com.messagehub.samples.MessageHubJavaSample)
[2015-12-11 11:12:12,292] INFO Topics: [{"name":"mytopic","markedForDeletion":false}] (com.messagehub.samples.MessageHubJavaSample)
[2015-12-11 11:12:12,531] INFO class com.messagehub.samples.ConsumerRunnable is starting. (com.messagehub.samples.ConsumerRunnable)
[2015-12-11 11:12:12,531] INFO class com.messagehub.samples.ProducerRunnable is starting. (com.messagehub.samples.ProducerRunnable)
[2015-12-11 11:12:14,208] INFO Message produced, offset: 0 (com.messagehub.samples.ProducerRunnable)
[2015-12-11 11:12:14,308] INFO Message: [{"value":"This is a test message0","timestamp":"Mon Feb 01 14:11:28 GMT 2016"}] (com.messagehub.samples.ConsumerRunnable)
[2015-12-11 11:12:15,343] INFO Message produced, offset: 1 (com.messagehub.samples.ProducerRunnable)
[2015-12-11 11:12:15,443] INFO Message: [{"value":"This is a test message1","timestamp":"Mon Feb 01 14:11:29 GMT 2016"}] (com.messagehub.samples.ConsumerRunnable)
[2015-12-11 11:12:16,480] INFO Message produced, offset: 2 (com.messagehub.samples.ProducerRunnable)
[2015-12-11 11:12:16,580] INFO Message: [{"value":"This is a test message2","timestamp":"Mon Feb 01 14:11:30 GMT 2016"}] (com.messagehub.samples.ConsumerRunnable)
```

## DIMPIPE Scenario:
- gradle clean && gradle fatJar
- mkdir -p tmp; mkdir -p run
- rm -rf tmp/* run/* ; cd tmp ; jar xf ../build/libs/message-hub-kafka-ssl-all-1.0.jar ; jar cfe ../run/mhub.jar com.messagehub.samples.MessageHubFetcher *; cd ..
- cd run
- wsk action invoke mhub mhub.jar
- wsk action invoke mhub --param apikey aEjcVlrmdUWBvZ9sRkbVwD0koZqHYjIYya4DiRr5Eh2gqKB8 --blocking --result

